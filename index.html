<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chrono Bulward v0.2.35</title>
<style>
  body { margin:0; background:#222; color:#eee; font-family:monospace; text-align:center; }
  #gameCanvas { background:#333; display:none; margin:0 auto; border:2px solid #000; }
  #menu, #settings, #help { margin-top:20px; }
  h1 { margin:20px; }
  .unit-settings { border:1px solid #555; padding:10px; margin:10px auto; width:90%; max-width:460px; text-align:left; }
  input[type=range] { width:260px; }
  #ui { margin-top:10px; display:none; }
  #ui button { margin:5px; padding:8px 16px; font-size:14px; }
  #help, #settings { display:none; text-align:left; max-width:720px; margin:20px auto; padding:12px; background:#111; border:1px solid #555; }
  h3 { cursor:pointer; margin:10px 0; }
</style>
</head>
<body>
<h1 id="title">Chrono Bulward v0.2.35</h1>

<div id="menu">
  <button onclick="startGame()">ゲーム開始</button>
  <button onclick="showSettings()">設定</button>
  <button onclick="showHelp()">説明</button>
</div>

<div id="settings">
  <h2>ユニット調整（キャラ名クリックで単体出現モード選択）</h2>
  <div id="unitSliders"></div>
  <div style="margin-top:8px;">
    <button onclick="backToMenu()">戻る</button>
    <button onclick="applySettingsAndStart()">ゲーム開始</button>
  </div>
</div>

<div id="help">
  <h2>ゲームのルール</h2>
  <p>自陣（下）からユニットを召喚し、敵陣（上）から進行してくる敵を防ぎます。<br>
  ユニット同士が接触すると戦闘開始、どちらかが倒れるまで移動を停止して戦闘を続けます。</p>
  <h2>主要ユニット</h2>
  <ul>
    <li>ナイト：近接</li>
    <li>アーチャー：遠距離</li>
    <li>クレリック：回復</li>
    <li>ゴーレム：敵専用・岩投げ</li>
    <li>巨大オーガ：ボス・近接</li>
    <li>邪竜：ボス・炎ブレス遠隔</li>
  </ul>
  <button onclick="backToMenuFromHelp()">戻る</button>
</div>

<canvas id="gameCanvas" width="400" height="600"></canvas>

<div id="ui">
  <button onclick="chooseUnit('swordsman')">ナイト召喚</button>
  <button onclick="chooseUnit('archer')">アーチャー召喚</button>
  <button onclick="chooseUnit('healer')">クレリック召喚</button>
</div>

<script>
/* =========================
   Chrono Bulward v0.2.35
   - 単体出現モード：中央レーンに1体のみ
   - 通常モード：ボス除外
   - UI切替/ユニット配置/敵出現を修正
========================= */

// ==== UI切替 ====
function showSettings(){ document.getElementById("menu").style.display="none"; document.getElementById("settings").style.display="block"; }
function backToMenu(){ document.getElementById("settings").style.display="none"; document.getElementById("menu").style.display="block"; }
function showHelp(){ document.getElementById("menu").style.display="none"; document.getElementById("help").style.display="block"; }
function backToMenuFromHelp(){ document.getElementById("help").style.display="none"; document.getElementById("menu").style.display="block"; }

let singleSpawnUnit=null;

let unitStats={
  swordsman:{hp:120, atk:10, speed:0.25, range:25},
  archer:{hp:80, atk:8, speed:0.25, range:120},
  healer:{hp:100, atk:10, speed:0.25, range:80},
  goblin:{hp:60, atk:5, speed:0.20, range:25},
  orc:{hp:200, atk:15, speed:0.20, range:25},
  shaman:{hp:120, atk:12, speed:0.25, range:120},
  phantom:{hp:80, atk:10, speed:0.50, range:100},
  golem:{hp:400, atk:20, speed:0.10, range:45},
  ogre:{hp:1500, atk:40, speed:0.10, range:30},
  dragon:{hp:3000, atk:70, speed:0.15, range:120}
};

// ==== 設定スライダー生成 ====
const unitConfig={ swordsman:{name:"ナイト",props:{hp:[50,300],atk:[5,30],speed:[0.1,1,0.05],range:[10,100]}}, /* …省略（他ユニット同様） */ };
const unitSlidersDiv=document.getElementById("unitSliders");
// （ここは省略しますが v0.2.34 と同じ処理でOK）

// ==== ゲーム本体 ====
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
let playerBaseHP,enemyBaseHP,playerUnits,enemyUnits,projectiles,hitMarks,swingMarks;
let pendingUnitType=null;
let enemySpawnTimer=null;

class Unit{
  constructor(type,side,lane,y){
    this.type=type; this.side=side; this.lane=lane;
    this.x=lane*(canvas.width/5)+(canvas.width/10);
    this.y=y;
    const st=unitStats[type];
    this.hp=st.hp; this.atk=st.atk; this.speed=st.speed||0.2; this.range=st.range||25;
    this.role="melee";
    if(type==="archer") this.role="archer";
    if(type==="healer") this.role="healer";
    if(type==="shaman") this.role="shaman";
    if(type==="phantom") this.role="phantom";
    if(type==="golem"&&side==="enemy") this.role="golemRanged";
    if(type==="dragon") this.role="dragonRanged";
    this.color=(side==="player")?(type==="archer"?"cyan":type==="healer"?"green":"blue"):"red";
    const nameMap={swordsman:"ナ",archer:"弓",healer:"聖",goblin:"ゴ",orc:"オ",shaman:"シ",phantom:"フ",golem:"岩",ogre:"巨",dragon:"竜"};
    this.label=nameMap[type]||"?";
    this.target=null; this.cooldown=0;
  }
  draw(){ ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=(this.side==="player")?"white":"black";
    ctx.font="14px sans-serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(this.label,this.x,this.y); }
  update(){ if(this.target){ if(this.target.hp<=0||!inMeleeRange(this,this.target)) this.target=null; else return; }
    this.y+=(this.side==="player"?-this.speed:this.speed); }
}

// ==== Projectile/HealProjectile/HitMark/HealMark/SwingMark クラス ====
// （前回v0.2.34で出したコードをそのまま入れてください）

// ==== 判定 ====
function inMeleeRange(a,b){ const laneDiff=Math.abs(a.lane-b.lane); const dy=Math.abs(a.y-b.y);
  if(laneDiff===0) return dy<=24; if(laneDiff===1) return dy<=20; return false; }
function inUnitRange(a,b){ const dx=(a.lane-b.lane)*(canvas.width/5); const dy=(a.y-b.y); return Math.hypot(dx,dy)<=a.range; }

// ==== ゲーム開始 ====
function startGame(){
  document.getElementById("menu").style.display="none";
  document.getElementById("settings").style.display="none";
  document.getElementById("help").style.display="none";
  document.getElementById("title").style.display="none";
  canvas.style.display="block"; document.getElementById("ui").style.display="block";
  playerBaseHP=100; enemyBaseHP=100;
  playerUnits=[]; enemyUnits=[]; projectiles=[]; hitMarks=[]; swingMarks=[];
  if(enemySpawnTimer) clearInterval(enemySpawnTimer);
  enemySpawnTimer=setInterval(spawnEnemy,4000);
  canvas.onclick=(e)=>{ if(!pendingUnitType) return;
    const rect=canvas.getBoundingClientRect();
    const lane=Math.floor((e.clientX-rect.left)/(canvas.width/5));
    playerUnits.push(new Unit(pendingUnitType,"player",lane,canvas.height-40));
    pendingUnitType=null; };
  requestAnimationFrame(loop);
}

function spawnEnemy(){
  if(singleSpawnUnit){ const lane=2;
    enemyUnits.push(new Unit(singleSpawnUnit,"enemy",lane,40));
    if(enemySpawnTimer){ clearInterval(enemySpawnTimer); enemySpawnTimer=null; }
    return; }
  const lane=Math.floor(Math.random()*5);
  const pool=["goblin","orc","golem","shaman","phantom"];
  const type=pool[Math.floor(Math.random()*pool.length)];
  enemyUnits.push(new Unit(type,"enemy",lane,40));
}

// ==== メインループ ====
// （ここに v0.2.34 の loop 完全版をそのまま貼る。近接/遠隔/回復処理あり）

function endScreen(text,color){ if(enemySpawnTimer){ clearInterval(enemySpawnTimer); enemySpawnTimer=null; }
  ctx.fillStyle=color; ctx.font="30px sans-serif"; ctx.fillText(text,120,300); }

function chooseUnit(type){ pendingUnitType=type; }
</script>
</body>
</html>
