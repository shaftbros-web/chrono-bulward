<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Mobile TD v0.2 â€” NeoGlass Edition</title>
<meta name="description" content="ã‚¹ãƒãƒ›å‘ã‘ï¼šè¿·è·¯å‹ã‚¿ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ã€‚ã‚¼ãƒ­ã‹ã‚‰åˆ·æ–°ã•ã‚ŒãŸä»¤å’Œæœ€æ–°ç‰ˆUIã€‚è¦‹åˆ‡ã‚Œé˜²æ­¢ãƒ»ãƒ‰ãƒ©ãƒƒã‚°é…ç½®ãƒ»å…¨10ã‚¦ã‚§ãƒ¼ãƒ–ã€‚" />
<style>
  :root{
    /* THEME */
    --bg0:#060910;
    --bg1:#0b1220;
    --glass:#0f1520cc;
    --stroke:#1e293b;
    --ink:#e6edf3;
    --muted:#9aa4b2;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --accent:#60a5fa;

    /* LAYOUT */
    --bar: 112px;
    --tile: 44px;      /* JSã§å¸¸ã«å†è¨ˆç®— */
    --grid-w: 12;
    --grid-h: 16;

    /* FX */
    --glow: 0 0 24px rgba(96,165,250,.35);
    --glow-red: 0 0 20px rgba(239,68,68,.4);
    --glow-green: 0 0 20px rgba(16,185,129,.35);
  }
  *{box-sizing:border-box;touch-action:manipulation}
  html,body{
    height:100dvh;margin:0;background:radial-gradient(1200px 800px at 70% -10%, #13223f 0%, #0a1221 45%, #060910 100%);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP','Hiragino Kaku Gothic ProN','Yu Gothic',Meiryo,sans-serif;
    overflow:hidden;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;
  }

  /* èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
  .stars{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.35;background:
    radial-gradient(2px 2px at 20% 30%, #8fb5ff 0 40%, transparent 45%),
    radial-gradient(2px 2px at 70% 20%, #8fb5ff 0 40%, transparent 45%),
    radial-gradient(2px 2px at 40% 70%, #8fb5ff 0 40%, transparent 45%),
    radial-gradient(1.6px 1.6px at 85% 65%, #8fb5ff 0 40%, transparent 45%)
    ;
    animation: twinkle 6s linear infinite;
  }
  @keyframes twinkle{50%{opacity:.55}}

  #wrap{position:relative; min-height:100%; display:grid; grid-template-rows:1fr auto; z-index:1}
  #fieldWrap{
    position:relative; overflow:hidden;
    border-bottom:1px solid var(--stroke);
    touch-action:none;
    backdrop-filter: blur(2px);
  }

  /* æˆ¦å ´ã‚°ãƒªãƒƒãƒ‰ */
  #grid{
    position:relative;
    display:grid;
    grid-template-columns:repeat(var(--grid-w), var(--tile));
    grid-template-rows:repeat(var(--grid-h), var(--tile));
    width:calc(var(--grid-w) * var(--tile));
    height:calc(var(--grid-h) * var(--tile));
    margin:0 auto;
    touch-action:none;
    outline:1px solid #0c1a2b;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.03), 0 10px 30px rgba(0,0,0,.45);
    border-radius:16px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0) 45%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.045) 0 1px, transparent 1px 44px),
      repeating-linear-gradient(90deg, rgba(255,255,255,.045) 0 1px, transparent 1px 44px),
      #0b1220;
  }
  .cell{
    width:var(--tile); height:var(--tile);
    border:1px solid #0f172a33;
    background:transparent;
  }
  .cell.wall{ background:linear-gradient(180deg,#0e1a2b,#0a1524); border-color:#0a122099 }
  .cell.path{ background:linear-gradient(180deg, #0f304f99, #0c253c99) }
  .cell.start{ background:linear-gradient(180deg,#0f513f,#0a2f26); box-shadow: inset 0 0 10px #0f513f55 }
  .cell.goal{ background:linear-gradient(180deg,#4a1e1e,#2b0c0c); box-shadow: inset 0 0 10px #ef444422 }

  /* ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ */
  .entity{ position:absolute; pointer-events:none; translate:-50% -50%; }

  .enemy{ width:28px;height:28px;border-radius:8px;
    background:linear-gradient(145deg,#ff6b6b,#b91c1c);
    box-shadow: var(--glow-red), 0 0 0 2px rgba(0,0,0,.25);
  }
  .enemy.tank{ width:36px;height:36px; background:linear-gradient(145deg,#9a1b1b,#5f0f0f) }
  .enemy.bike{ width:24px;height:24px; background:linear-gradient(145deg,#ff9340,#cc5f0a) }
  .enemy.boss{ width:48px;height:48px; background:linear-gradient(145deg,#7f1d1d,#4a0f0f); outline:3px solid #fecaca; box-shadow: var(--glow-red) }

  .tower,.unit{
    width:30px;height:30px;border-radius:10px;
    background:linear-gradient(145deg,#7fb3ff,#2463eb);
    border:2px solid #1d4ed8;
    box-shadow: var(--glow);
  }
  .tower.sniper{ background:linear-gradient(145deg,#c7b8ff,#6d28d9); border-color:#6d28d9 }
  .tower.mg{ background:linear-gradient(145deg,#6ee7b7,#059669); border-color:#059669 }
  .unit.infantry{ background:linear-gradient(145deg,#ffc86b,#b45309); border-color:#b45309 }
  .unit.vehicle{ background:linear-gradient(145deg,#e5e7eb,#475569); border-color:#475569 }

  .trap.mine{
    width:22px;height:22px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #ff92a3 0 40%, #a40317 60%);
    border:2px dashed #7f1d1d;
    box-shadow:0 0 12px rgba(244,63,94,.38);
  }
  .trap.slow{
    width:34px;height:34px;border-radius:10px;
    background:linear-gradient(145deg,#1e293bb3,#334155b3);
    border:2px solid #334155;
    box-shadow:0 0 14px rgba(96,165,250,.25) inset;
  }

  .bullet{
    width:8px;height:8px;border-radius:50%;
    background: radial-gradient(circle at 35% 35%, #fff7b0 0 40%, #eab308 55%, #c28705 100%);
    box-shadow:0 0 12px rgba(234,179,8,.8);
  }

  .spark{
    position:absolute; width:10px;height:10px; border-radius:50%;
    background:radial-gradient(circle, #fff 0 25%, rgba(255,255,255,0) 70%);
    pointer-events:none; translate:-50% -50%; opacity:.85; animation:spark .18s ease-out forwards;
  }
  @keyframes spark{ to{ transform:scale(1.8); opacity:0 } }

  .ghost{
    position:absolute; pointer-events:none; translate:-50% -50%;
    border:2px dashed #93c5fd88; border-radius:12px; background:#60a5fa14; box-shadow: var(--glow);
  }

  /* ä¸‹ãƒãƒ¼ï¼ˆã‚°ãƒ©ã‚¹ï¼‰ */
  #bar{
    position:relative;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    padding:10px 12px calc(12px + env(safe-area-inset-bottom));
    display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
    min-height:var(--bar);
    border-top:1px solid #ffffff14; backdrop-filter: blur(10px);
  }
  #stats{display:flex;gap:14px;align-items:center;font-size:14px;color:var(--muted)}
  #stats b{color:var(--ink)}
  #palette{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .item{
    display:flex;flex-direction:column;align-items:center;gap:6px;
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border:1px solid #ffffff20; padding:8px 10px; border-radius:12px; min-width:70px;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
  }
  .item.sel{outline:2px solid var(--accent)}
  .item .ico{width:30px;height:30px;border-radius:8px}
  .item .name{font-size:12px;color:#d7dee6}
  .item .cost{font-size:11px;color:#a8b3bf}

  /* ç”»é¢ä¸Šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  #ctrls{position:absolute;left:12px;top:12px;display:flex;gap:8px;z-index:3}
  .btn{
    appearance:none;border:none;border-radius:999px;background:#111827cc;
    color:#e5e7eb;padding:9px 14px;font-size:12px;border:1px solid #ffffff22; backdrop-filter: blur(8px);
  }
  .btn:active{transform:translateY(1px)}

  /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚°ãƒ©ã‚¹ï¼‰ */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:5}
  .overlay.show{display:flex}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border:1px solid #ffffff22;border-radius:20px;max-width:560px;width:92%;padding:18px;
    box-shadow:0 30px 80px rgba(0,0,0,.55); backdrop-filter: blur(12px);
  }
  .panel h1{font-size:22px;margin:0 0 8px}
  .panel h2{font-size:16px;margin:12px 0 6px;color:#cbd5e1}
  .panel p{margin:4px 0;color:#9aa4b2}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .chip{
    border:1px solid #ffffff22;background:#111827b3;color:#e5e7eb;padding:10px 14px;border-radius:999px;font-size:14px
  }
  .chip.sel{outline:2px solid var(--accent)}

  #toast{
    position:absolute;left:50%;top:14px;transform:translateX(-50%);
    background:#111827cc;border:1px solid #ffffff22;color:#e5e7eb;border-radius:999px;padding:8px 14px;font-size:13px;
    opacity:0;transition:opacity .18s;z-index:6; backdrop-filter: blur(8px);
  }
  #toast.show{opacity:1}
</style>
</head>
<body>
<div class="stars" aria-hidden="true"></div>

<div id="wrap">
  <div id="fieldWrap">
    <div id="ctrls">
      <button class="btn" id="btnStartWave">Waveé–‹å§‹</button>
      <button class="btn" id="btnPause">ä¸€æ™‚åœæ­¢</button>
      <button class="btn" id="btnSpeed">é€Ÿåº¦Ã—1</button>
    </div>
    <div id="grid" aria-label="æˆ¦å ´"></div>
    <div id="toast"></div>

    <div id="overlay" class="overlay show" role="dialog" aria-modal="true">
      <div class="panel">
        <h1>Mobile TD â€” NeoGlass Edition</h1>
        <p>ã‚¿ãƒƒãƒ—ï¼†ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚¿ãƒ¯ãƒ¼/ç½ /ãƒ¦ãƒ‹ãƒƒãƒˆã‚’é…ç½®ã€‚å…¨10ã‚¦ã‚§ãƒ¼ãƒ–ã‚’é˜²è¡›ã›ã‚ˆï¼</p>
        <h2>é›£æ˜“åº¦ã‚’é¸æŠ</h2>
        <div class="row" id="difficulty">
          <button class="chip" data-diff="easy">Easy</button>
          <button class="chip sel" data-diff="normal">Normal</button>
          <button class="chip" data-diff="hard">Hard</button>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="btn" id="btnStartGame">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>
      </div>
    </div>

    <div id="result" class="overlay" role="dialog" aria-modal="true">
      <div class="panel">
        <h1 id="resultTitle">çµæœ</h1>
        <p id="resultStats"></p>
        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="btn" id="btnBackTitle">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
      </div>
    </div>
  </div>

  <div id="bar">
    <div id="stats">
      <div>ğŸ’° <b id="money">0</b></div>
      <div>â¤ï¸ <b id="life">0</b></div>
      <div>ğŸ“¶ Wave <b id="wave">0</b>/10</div>
    </div>
    <div id="palette" aria-label="é…ç½®ãƒ‘ãƒ¬ãƒƒãƒˆ"></div>
  </div>
</div>

<script>
(()=>{"use strict";
  /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
  const $=(s,el=document)=>el.querySelector(s);
  const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const vibrate=(ms)=>{ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch{} };

  const toastEl=$('#toast'); let toastTimer=null;
  function toast(msg){
    toastEl.textContent=msg; toastEl.classList.add('show');
    clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove('show'),1200);
  }

  /* ===== å®šæ•° ===== */
  const GRID_W=12, GRID_H=16;
  const TILE=()=>parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile'));
  const START={x:0,y:Math.floor(GRID_H/2)}, GOAL={x:GRID_W-1,y:Math.floor(GRID_H/2)};

  const DIFFS={
    easy:{ enemyHP:0.9, enemyNum:0.9, reward:1.15, startMoney:230, life:26 },
    normal:{ enemyHP:1.0, enemyNum:1.0, reward:1.0, startMoney:185, life:20 },
    hard:{ enemyHP:1.2, enemyNum:1.15, reward:0.9, startMoney:150, life:18 },
  };

  const ITEMS=[
    { key:'tower_basic',  kind:'tower', name:'åŸºæœ¬',   cost:60,  range:2.6, dmg:10, rof:1.0, iconClass:'tower' },
    { key:'tower_sniper', kind:'tower', name:'ç‹™æ’ƒ',   cost:115, range:5.2, dmg:30, rof:0.42, iconClass:'tower sniper' },
    { key:'tower_mg',     kind:'tower', name:'é€£å°„',   cost:88,  range:2.3, dmg:6,  rof:3.0, iconClass:'tower mg' },
    { key:'trap_mine',    kind:'trap',  name:'åœ°é›·',   cost:35,  iconClass:'trap mine' },
    { key:'trap_slow',    kind:'trap',  name:'æ¸›é€Ÿ',   cost:55,  slow:0.55, iconClass:'trap slow' },
    { key:'unit_inf',     kind:'unit',  name:'æ­©å…µ',   cost:50,  range:1.9, dmg:8,  rof:1.2, iconClass:'unit infantry' },
    { key:'unit_vehicle', kind:'unit',  name:'è»Šä¸¡',   cost:120, range:2.4, dmg:14, rof:1.0, iconClass:'unit vehicle' },
  ];

  const WAVES=[
    { list:[{type:'inf', n:12, gap:0.7}] },
    { list:[{type:'inf', n:16, gap:0.65}] },
    { list:[{type:'inf', n:18, gap:0.6}] },
    { list:[{type:'inf', n:16, gap:0.5},{type:'bike', n:6, gap:0.9}] },
    { list:[{type:'bike', n:10, gap:0.8},{type:'inf', n:10, gap:0.6}] },
    { list:[{type:'bike', n:14, gap:0.7}] },
    { list:[{type:'tank', n:5, gap:1.2},{type:'bike', n:8, gap:0.8}] },
    { list:[{type:'tank', n:6, gap:1.1},{type:'inf', n:12, gap:0.6}] },
    { list:[{type:'tank', n:8, gap:1.0}] },
    { list:[{type:'boss', n:1, gap:0.0}] },
  ];

  const ENEMY_BASE={
    inf:{ hp:30, spd:1.0, reward:6, dmg:1, class:'enemy' },
    bike:{ hp:26, spd:1.8, reward:8, dmg:1, class:'enemy bike' },
    tank:{ hp:180, spd:0.6, reward:20, dmg:2, class:'enemy tank' },
    boss:{ hp:1200, spd:0.5, reward:120, dmg:5, class:'enemy boss' },
  };

  /* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–ï¼ˆè¦‹åˆ‡ã‚Œã‚¼ãƒ­ï¼‰ ===== */
  const gridEl = $('#grid'), fieldWrap = $('#fieldWrap'), barEl = $('#bar');

  function measureViewportH(){
    // å®ŸåŠ¹è¡¨ç¤ºé«˜ã•ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ç¸®å°ãªã©ã«è¿½éšï¼‰
    return (window.visualViewport?.height ?? window.innerHeight);
  }
  function resizeField(){
    const vh = measureViewportH();
    const barH = barEl.getBoundingClientRect().height || parseInt(getComputedStyle(document.documentElement).getPropertyValue('--bar')) || 100;
    // ä½™ç™½ã‚’å°‘ã—å¼•ãï¼ˆä¸Šä¸‹åˆã‚ã›ã¦16pxï¼‰
    const usableH = Math.max(220, vh - barH - 16);
    const usableW = Math.max(280, window.innerWidth - 16);
    // ã‚°ãƒªãƒƒãƒ‰ãŒå¿…ãšåã¾ã‚‹ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆæŒ‡å…ˆã‚¿ãƒƒãƒ—ã‚’è€ƒæ…®ã—ã¦ä¸‹é™26pxï¼‰
    const tileH = Math.floor(usableH / GRID_H);
    const tileW = Math.floor(usableW / GRID_W);
    const tile = Math.max(26, Math.min(tileH, tileW));
    document.documentElement.style.setProperty('--tile', tile+'px');

    // é«˜ã•ç¢ºä¿ï¼ˆã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢è¾¼ã¿ï¼‰
    fieldWrap.style.minHeight = `${Math.ceil(usableH)}px`;
  }
  // åˆå›ï¼‹å‹•çš„å¤‰åŒ–ã«è¿½éš
  window.addEventListener('resize', resizeField);
  window.visualViewport && window.visualViewport.addEventListener('resize', resizeField);

  /* ===== ãƒãƒƒãƒ—ï¼†æç”» ===== */
  const map = createBaseMap();
  function createBaseMap(){
    // 0:ç©ºã 1:å£ 2:ã‚¹ãƒ­ãƒ¼ 3:åœ°é›· 4:å æœ‰
    const arr = Array.from({length:GRID_H},()=>Array(GRID_W).fill(0));
    // è¿·è·¯æ„Ÿï¼šä¸Šä¸‹ã«ä½ã„å£ï¼ˆæ‰€ã€…æ¬ ã‘ï¼‰
    for(let x=2;x<GRID_W-2;x++){
      const y1=Math.floor(GRID_H/2)-3, y2=Math.floor(GRID_H/2)+3;
      if(x%4!==0){ arr[y1][x]=1; arr[y2][x]=1; }
    }
    arr[START.y][START.x]=0; arr[GOAL.y][GOAL.x]=0;
    return arr;
  }

  function renderGrid(){
    gridEl.innerHTML='';
    for(let y=0;y<GRID_H;y++){
      for(let x=0;x<GRID_W;x++){
        const d=document.createElement('div'); d.className='cell';
        d.dataset.x=x; d.dataset.y=y;
        if(map[y][x]===1) d.classList.add('wall');
        if(x===START.x && y===START.y) d.classList.add('start');
        if(x===GOAL.x && y===GOAL.y) d.classList.add('goal');
        gridEl.appendChild(d);
      }
    }
  }

  /* ===== A* ===== */
  function astar(start, goal, mapOverride){
    const grid=mapOverride||map, key=(x,y)=>`${x},${y}`;
    const open=[{x:start.x,y:start.y,g:0,f:0}], came=new Map();
    const gscore=new Map([[key(start.x,start.y),0]]);
    function heur(a,b){ return Math.abs(a.x-b.x)+Math.abs(a.y-b.y); }
    function neighbors(x,y){
      const arr=[]; [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{
        const nx=x+dx, ny=y+dy;
        if(nx>=0&&nx<GRID_W&&ny>=0&&ny<GRID_H && grid[ny][nx]!==1 && grid[ny][nx]!==4) arr.push({x:nx,y:ny});
      }); return arr;
    }
    while(open.length){
      let best=0; for(let i=1;i<open.length;i++){ if(open[i].f<open[best].f) best=i; }
      const cur=open.splice(best,1)[0];
      if(cur.x===goal.x && cur.y===goal.y){
        const path=[{x:cur.x,y:cur.y}]; let ck=key(cur.x,cur.y);
        while(came.has(ck)){ const p=came.get(ck); path.push(p); ck=key(p.x,p.y); }
        return path.reverse();
      }
      for(const nb of neighbors(cur.x,cur.y)){
        const g=(gscore.get(key(cur.x,cur.y)) ?? Infinity)+1, nk=key(nb.x,nb.y);
        if(g < (gscore.get(nk) ?? Infinity)){
          came.set(nk,{x:cur.x,y:cur.y}); gscore.set(nk,g);
          const f = g + heur(nb,goal);
          if(!open.find(n=>n.x===nb.x&&n.y===nb.y)) open.push({x:nb.x,y:nb.y,g,f});
        }
      }
    }
    return null;
  }
  function paintPath(path){
    $$('.cell').forEach(c=>c.classList.remove('path'));
    if(!path) return;
    for(const p of path){
      const c=$(`.cell[data-x="${p.x}"][data-y="${p.y}"]`);
      if(c && !c.classList.contains('start') && !c.classList.contains('goal')) c.classList.add('path');
    }
  }

  /* ===== çŠ¶æ…‹ ===== */
  const state={
    running:false, paused:false, speed:1, diff:'normal',
    money:0, life:20, wave:0,
    enemies:[], towers:[], units:[], traps:[], bullets:[]
  };
  const moneyEl=$('#money'), lifeEl=$('#life'), waveEl=$('#wave');
  function refreshStats(){ moneyEl.textContent=state.money|0; lifeEl.textContent=state.life; waveEl.textContent=state.wave; }

  /* ===== ãƒ‘ãƒ¬ãƒƒãƒˆ ===== */
  function buildPalette(){
    const pal=$('#palette'); pal.innerHTML='';
    ITEMS.forEach((it,i)=>{
      const d=document.createElement('button'); d.className='item'; d.type='button'; d.dataset.index=i; d.dataset.key=it.key;
      d.innerHTML=`<div class="ico ${it.iconClass}"></div><div class="name">${it.name}</div><div class="cost">${it.cost}</div>`;
      pal.appendChild(d);
    });
  }

  /* ===== é…ç½® ===== */
  let placing=null, placingCell=null;
  $('#palette').addEventListener('pointerdown', (e)=>{
    const btn=e.target.closest('.item'); if(!btn) return; e.preventDefault();
    const idx=+btn.dataset.index, item=ITEMS[idx]; startPlacing(item,e);
  });
  gridEl.addEventListener('pointerdown',(e)=>{
    if(!placing) return; e.preventDefault();
    const r=gridEl.getBoundingClientRect();
    const gx=clamp(Math.floor((e.clientX - r.left)/TILE()),0,GRID_W-1);
    const gy=clamp(Math.floor((e.clientY - r.top)/TILE()),0,GRID_H-1);
    placingCell={x:gx,y:gy}; tryPlace(placing.item,gx,gy); cancelPlacing();
  });

  function startPlacing(item,e){
    if(state.paused){ toast('ä¸€æ™‚åœæ­¢ä¸­'); return; }
    if(state.money<item.cost){ toast('ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“'); vibrate(30); return; }
    $$('.item').forEach(x=>x.classList.remove('sel'));
    const src=$(`.item[data-key="${item.key}"]`); if(src) src.classList.add('sel');

    const g=document.createElement('div'); g.className='ghost';
    const size=item.kind==='trap' && item.key==='trap_slow' ? 34 : 30;
    g.style.width=size+'px'; g.style.height=size+'px'; gridEl.appendChild(g);
    placing={item,ghostEl:g}; moveGhost(e);

    window.addEventListener('pointermove',moveGhost);
    window.addEventListener('pointerup',endPlacing,{once:true});
    window.addEventListener('pointercancel',cancelPlacing,{once:true});
  }
  function moveGhost(e){
    if(!placing) return;
    const r=gridEl.getBoundingClientRect();
    const x=(e.clientX ?? e.touches?.[0]?.clientX), y=(e.clientY ?? e.touches?.[0]?.clientY);
    if(x==null||y==null) return;
    const gx=clamp(Math.floor((x-r.left)/TILE()),0,GRID_W-1);
    const gy=clamp(Math.floor((y-r.top)/TILE()),0,GRID_H-1);
    placingCell={x:gx,y:gy};
    placing.ghostEl.style.left=(gx*TILE()+TILE()/2)+'px';
    placing.ghostEl.style.top=(gy*TILE()+TILE()/2)+'px';
  }
  function endPlacing(){
    window.removeEventListener('pointermove',moveGhost);
    if(!placingCell){ cancelPlacing(); return; }
    tryPlace(placing.item, placingCell.x, placingCell.y);
    cancelPlacing();
  }
  function cancelPlacing(){
    if(placing){ placing.ghostEl.remove(); placing=null; }
    $$('.item').forEach(x=>x.classList.remove('sel'));
  }

  function cellBlockedForPlacement(x,y){
    if((x===START.x&&y===START.y)||(x===GOAL.x&&y===GOAL.y)) return true;
    if(map[y][x]===1) return true;
    return false;
  }
  function tryPlace(item,x,y){
    if(cellBlockedForPlacement(x,y)){ toast('ã“ã“ã«ã¯ç½®ã‘ã¾ã›ã‚“'); vibrate(15); return; }
    const temp=map.map(r=>r.slice());
    if(item.kind==='trap'){
      if(temp[y][x]!==0){ toast('ã“ã“ã«ã¯ç½®ã‘ã¾ã›ã‚“'); vibrate(15); return; }
      temp[y][x]=(item.key==='trap_slow')?2:3;
    }else{
      if(temp[y][x]!==0){ toast('ã“ã“ã«ã¯ç½®ã‘ã¾ã›ã‚“'); vibrate(15); return; }
      temp[y][x]=4;
    }
    const p=astar(START,GOAL,temp);
    if(!p){ toast('çµŒè·¯ã‚’ãµã•ã’ã¾ã›ã‚“'); vibrate(25); return; }

    if(state.money<item.cost){ toast('ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
    state.money-=item.cost; refreshStats();

    if(item.kind==='trap'){
      if(item.key==='trap_slow'){ map[y][x]=2; spawnTrap(x,y,'slow',item); }
      else{ map[y][x]=3; spawnTrap(x,y,'mine',item); }
      SE.place();
    }else if(item.kind==='tower'){ map[y][x]=4; sp
